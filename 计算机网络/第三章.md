# 第三章 数据链路层
数据链路层位于网络的底层，使用两种信道：
1. 点对点信道
2. 广播信道
## 使用点对点信道的数据链路层
### 数据链路和帧
* 数据链路和链路：
  * 链路（link）：一个结点到相邻结点的一段物理线路，中间没有任何其他的结点。
  * 数据链路：在链路的基础上，增加了实现传输协议的硬件和软件 
  * 通常使用网络适配器来实现协议。
* 帧：数据链路层把网络层交下来的数据构成帧发送到链路上，网络层的数据单元是IP数据报，数据链路层的数据单元式帧。
* 通信的主要步骤：
    1. 结点A的数据链路层把网络层的IP数据报添加首尾部封装成帧
    2. 结点A把帧发送给结点B
    3. 结点B接收，确认无差错，提取IP数据报交给网络层
### 三个基本问题
* 封装称帧：IP数据报前后添加首尾部
  * 是分组交换的必要条件
  * 帧长为帧的数据部分长度加帧首部和帧尾部的长度。
  * 首尾部用于进行帧定界和保存控制信息，通常首部为开始符SOH，尾部为结束符EOT。
  * 协议规定了数据部分的长度上限——最大传送单元MTU。
  * 为保证传输效率，数据部分要大于首尾部的长度。
  * 当传输出现差错后，接收端只接收开始符SOH，未接受结束符EOT，表面传输故障，丢弃当前帧。只有完整接收帧定界符才接收帧。
* 透明传输：避免数据与帧定界符混淆
  * 解决方法：字节填充法  
    * 加入转义字符ESC（16进制编码1B，二进制编码00011011）
    * 接收端识别转义字符后，删除转义字符，后续字符不会识别为控制字符。
* 差错检测：防止差错的无效数据帧浪费后续信道上的传输和处理资源
  * 比特差错：传输过程中，0变1或1变0.
  * 误码率BER：传输错误的比特的占比。
  * 误码率与信噪比有关系，信噪比提高，误码率减小。
  * 识别方法：**循环冗余检验CRC**
    * 在数据后添加用于差错检验的n位冗余码
    * 具体步骤：设数据位 M = 101001，除数P = 1101，n = 3
        1. 设置冗余码长度n
        2. 对数据M进行模2运算，即添加n个0，M = 101001000
        3. 对M除以事先商定的长度位n+1的除数P，得到商 Q = M / P = 110101，余数R = M % P = 001.
        4. R作为冗余码拼接，则M为101001001
    * 冗余码又称为**帧检验序列FCS**
    * 若传输过程无差错，则接收端对帧除以相同除数P，余数R必为0，否则出错。
    * 除数P通常使用**生成多项式P**表示，例$P(X) = X^3 + x^2 + 1$,表示P = 1101
    * 常用的生成多项式：
      * $CRC-16=x^16 + x^15 + x^2 + 1$
      * $CRC-CCITT=x^16 + x^12 + x^5 + 1$
      * $CRC-32 = x^32 + x^26 + x^23 + x^22 + x^16 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x + 1$
    * CRC只能做到对帧的无差错接收，凡是接收端接收的帧，以接近1的概率认为帧在传输过程中没有产生差错
    * 数据链路层无需进行可靠传输，即发送端发送什么，接收端都接受
    * 差错类别：
      * 比特差错：最基本的差错
      * 出现传输差错：帧丢失、帧重复、帧失序
#### 点对点协议
* PPP的特点：用户计算机和ISP进行通信时所使用的数据链路层协议
  * 满足的需求：
    * 简单：CRC检验正确接收，否则丢弃。
    * 封装成帧
    * 透明
    * 多种网络层协议：在同一条物理链路上同时支持多种网络层协议
    * 多种类型链路
    * 差错检测：丢弃有差错的帧
    * 检测连接状态：保证资源不浪费
    * 最大传送单元MTU：不是总长度，时数据部分的长度。
    * 网络层地址协商
    * 数据压缩协商
  * PPP协议不需要进行纠错，不需要设置序号，不需要进行流量控制
  * 组成：
    1. 将IP数据报封装到串行链路的方法。
    2. 用来建立、配置和测试数据链路连接的链路控制协议LCP
    3. 网络控制协议NCP
* PPP协议的帧格式
  
<table>
    <tr>
        <th colspan="4">首部</th>
        <th>信息字段</th>
        <th colspan="2">尾部</th>
    </tr>
    <tr>
        <td>标志</td>
        <td>地址</td>
        <td>控制</td>
        <td>协议</td>
        <td>信息</td>
        <td>校验</td>
        <td>标志</td>
    </tr>
    <tr>
        <td>7E</td>
        <td>FF</td>
        <td>03</td>
        <td>0021/C021/8021</td>
        <td>1500B</td>
        <td>FCS</td>
        <td>7E</td>
    </tr>
</table>

其中首部的地址和控制无实义。  
协议部分字段为0021，表示信息字段为IP数据报；C021表示为控制协议LCP；8021表示网络层的控制数据  
* 字节填充：使用异步传输时的填充方式
  * 转义字符为7D
  * 当信息数据出现7E，转化为7D7E
  * 当出现7D，转化为7D7D
  * 出现ASCll的控制字符（即小于0x20的字符）， 则在前面加入7D
* 零比特填充：使用同步传输的填充方式
  * 发送端扫描信息字段，若出现5个连续的1，则立即填入0
  * 接收端收到帧，扫描帧，找到5个连续1，则删除一个0
### PPP协议的工作状态


## 使用广播信道的数据链路层
### 局域网的数据链路层：
  * 特点：网络为一个单位所有，地理范围和站点数目有限
  * 优点：
    1. 具有广播功能
    2. 便于系统的扩展和逐渐演变
    3. 提高了系统的可靠性、可用性和生存性
  * 分类：
    * 星型：使用集线器hub
    * 环型
    * 总线型
  * 共享信道：
    * 静态划分信道：频分、时分、码分
      * 代价较高，不适合局域网
    * 动态媒体接入控制：多点接入
      * 随机接入：需要解决碰撞
      * 受控接入
    * 随机接入的以太网被广泛使用。
  * 以太网：
    * 数据链路层拆分为逻辑链路控制LLC和媒体接入控制MAC。LLC已淘汰，主要使用MAC层。
  * 适配器：网络接口卡NIC或简称网卡
    * 作用：
      1. 数据串行传输和并行传输的转换
      2. 安装设备驱动程序
      3. 实现以太网协议
    * 适配器在接收和发送帧时，不使用计算机的CPU。 
### CSMA/CD协议
* **CSMA/CD：载波监听多点接入/碰撞检测**
* 以太网为通信便捷采用的措施：
  * 采用较灵活的无连接的工作方式，不必先建立连接就可以直接发送数据。
    * 适配器对发送的数据帧不进行编号，不要求对方发回确认。
    * 以太网提供的服务是尽最大努力交付，即不可靠交付。
    * 对差错帧是否有重传需求由高层决定。
    * 以太网不能识别重传帧，都以新的数据帧来传。
  * 使用曼彻斯特编码
* CSMA/CD的要点：
  * 多点接入
  * 载波监听
  * 碰撞检测 
    * 电磁波在1km电缆的传播时延约为5us
    * 单程端到端传播时延记为$\tau$
    * **发送端最迟接收到碰撞信息的时间为2$\tau$，为两倍的总线端到端的传播时延，称为争用期。或碰撞窗口**
* 使用CSMA/CD协议时，一个站不可能同时进行发送和接收（必须边发边监听）。
* 使用CSMA/CD的以太网只能进行双向交替通信。
* 每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性，这段时间无法确定，称为发送的不确定性。
* 以太网使用**截断二进制指数退避算法**确定重传时间
  * 协议规定基本退避时间为争用期2$\tau$，具体为51.2us，或直接使用比特作为单位，为512bit。
  * 从离散的整数集合$[0,1,...,(2^k - 1)]$中随机取一个数,记为r，重传时间为r倍的争用期。参数k的取用如下：
    * $k = Min[重传次数，10]$
  * 当重传达16次能不能成功，则丢弃并报告。
* 以太网规定了最小传输字节长度为64字节，避免无法检测碰撞，凡是长度小于64字节的帧都是由冲突而异常终止的无效帧。
* 强化碰撞：碰撞检测到时，发送32bit或48bit的人为干扰信号。
* 帧间最小间隔9.6us，用于接收、清理缓存
* CSMA/CD要点：
  * 准备发送：接收网络层数据，组成以太网帧，发送前检测信道。
  * 检测信道：检测信道直至空闲，确保帧间最小间隔后，发送帧
  * 边发边监听：
    * 发送成功：争用期内未检测到碰撞。
    * 发送失败：检测到碰撞，停止发送，发送认为干扰信号，适配器使用指数退避算法。
### 使用集线器的星形拓扑
  * 10BASE-T：10表示10Mbit/s的数据率，BASE表示连接线上的信号是基带信号，T代表双绞线
  * 集线器的特点：
    * 使用集线器的以太网在逻辑上仍然是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议。
    * 一个集线器有很多接口
    * **集线器工作在物理层**，每个接口仅简单地转发比特，不进行碰撞检测
    * 集线器采用了专门的芯片，进行自适应串音回波抵消。
### 以太网的信道利用率
  * 由于碰撞的存在，以太网总的信道利用率不能达到100%。
  * 成功发送帧的最短信道占用时间为$T_0 + \tau$。
  * 单程端到端时延$\tau$与帧的发送时间$T_0$之比a：$a = \frac{\tau}{T_0}$
    * a越小，争用期占比越少，效率更高。
    * 当数据率一定时，以太网的连线的长度收到限制，同时以太网的帧长不能太短。
### 以太网的MAC层
  * MAC层的硬件地址：IEEE802规定了48位的全球地址，固化在了适配器的ROM中。
    * 前三字节为公司标识符OUI
    * 后三字节为扩展标识符
    * 48位地址称作硬件地址、物理地址、适配器标识符EUI-48
    * 其中第一字节的最低位为I/G位，为0表示为单个站地址，1表示组地址
    * 第一字节的最低第二位 为G/L位，0表示全球管理，1表示本地管理。
    * 适配器具有过滤功能，能识别三种帧：
      1. 单播帧
      2. 广播帧
      3. 多播帧
    * 所有适配器识别前两种帧，部分支持第三种帧
  * MAC帧的格式
    <table>
    <tr>
        <th colspan="2">8字节</th>
        <th colspan="5">MAC帧</th>
    </tr>
    <tr>
        <td>前同步码</td>
        <td>帧开始定界符</td>
        <td>目的地址</td>
        <td>源地址</td>
        <td>类型</td>
        <td>数据</td>
        <td>FCS</td>
    </tr>
    <tr>
        <td>7字节</td>
        <td>7字节</td>
        <td>6字节</td>
        <td>6字节</td>
        <td>2字节</td>
        <td>46-1500字节</td>
        <td>4字节</td>
    </tr>
    </table>

    * 以太网不需要帧结束定界符，也不需要插入字节保证透明传输，帧与帧之间存在间隔，检测到帧开始定界符，之后的连续比特流都属于一个MAC帧。
    * 无效的MAC帧：
      * 帧的长度不是整数个字节。
      * 用收到的帧检验序列FCS查出有差错。
      * 收到的帧的MAC客户数据字段的长度不在46-1500字节之间。
## 扩展的以太网
扩展的以太网在网络层看来仍然是一个网络。
### 在物理层扩展以太网
  * 使用光纤和光纤调制解调器扩展。
  * 光纤调制解调器的作用是进行电信号和光信号的转换。
  * 好处：
    1. 将不同系得以太网上得计算机能够进行跨系得通信
    2. 扩大了以太网覆盖的地理范围
  * 缺点：
    1. 某个系的两个站在通信时占用所有的集线器。
    2. 不同的系使用不同的以太网技术，则不可能使用集线器互连。
### 在数据链路层扩展以太网
  * 最初使用**网桥**对收到的帧根据MAC地址进行转发和过滤。
  * 1990年，交换式集线器，简称交换机或第二层交换机，淘汰了网桥。
  * 交换机的特点
    * 工作在数据链路层
    * 实质是一个多接口的网桥
    * 使用双全工方式
    * 具有并行性
    * 相互通信的主机都是独占传输媒体，无碰撞地传输数据。
    * 具有存储器，对繁忙地帧进行缓存
    * 即插即用，内部的帧交换表根据自学习算法建立。
  * 自学习功能
    * 根据收到的帧进行存储表的更新
    * 考虑主机更换，交换表的项目设置有效时间。
    * 防止无线循环，制定了生成树协议，在逻辑上切断某些链路。
  * 总线以太网与星形以太网
    * 总线以太网使用CSMA/CD协议，采用半双工方式工作。
    * 以太网交换机不适用共享总线，没有碰撞，双全工方式工作。
    * 由于帧结构仍采用以太网的帧结构，因此仍然叫做以太网。
### 虚拟局域网
  * 虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组。
  * 实质是给用户提供的一种服务，不是新的局域网。
  * 802ac标准定义了以太网的帧格式的扩展，用于支持虚拟局域网，插入了4个字节的标识符，称为VLAN标记。
  * VLAN标记的前两个字节设置为了0x8100，称为IEEE802.1Q标记类型
  * 当检测到MAC帧的源地址字段后面的两个字节的值是0x8100时，就知道了插入了VLAN。
  * 后两个字节中，前三位为用户优先级字段，接着一位为规范格式指示符CFI。最后12位为该虚拟局域网VLAN标识符VID，唯一的标识了以太网帧属于哪个VLAN
  <table>
    <tr>
        <th>802.1Q标记类型</th>
        <th colspan="3">标记控制信息</th>
    </tr>
    <tr>
        <td>0x8100</td>
        <td>用户优先级</td>
        <td>CFI</td>
        <td>VID</td>
    </tr>
    <tr>
        <td>10000001 00000000</td>
        <td>3位</td>
        <td>1位</td>
        <td>12位</td>
    </tr>
  </table>

## 高速以太网
### 100BASE-T以太网
  * 在双绞线上传送100Mbit/s基带信号的**星形拓扑以太网**，又称快速以太网。
  * 有很强的自适应性，自动识别10Mibt/s和100Mbits/s
  * 从细缆以太网升级到快速以太网的用户必须重新布线。
  * 快速以太网的争用期为5.12us，帧间最小间隔为0.96us
### 吉比特以太网
* 特点：
  * 允许在1Gbit/s下以全双工和半双工方式工作
  * 使用IEEE802.3协议规定的帧格式
  * 在半双工方式下使用CSMA/CD协议，在全双工方式不使用。
  * 与10BASE-T和100BASE-T技术向后兼容
* 在半双工方式工作时，需要碰撞检测
  * 使用载波延伸方法，最短帧长为64字节，争用期增大为512字节，不足512字节，则使用特殊字符填充
  * 增加了分组突发功能。很多短帧发送时，第一个短帧使用载波延伸，其后的短帧保留必要的帧间最小间隔连续发送，形成一串分组的突发。
### 10吉比特以太网和更快的以太网
* 帧格式与之前相同
* 只工作在全双工。
### 使用以太网进行宽带接入
* 提供双向的宽带通信
* 不能进行用户识别